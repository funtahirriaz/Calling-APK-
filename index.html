<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Supabase ChatApp</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; }
    #app { max-width: 400px; margin: auto; padding: 20px; background:white; border-radius: 10px; }
    input, button { padding:10px; margin:5px 0; width:100%; }
    #chat { border:1px solid #ccc; height:300px; overflow-y:scroll; margin:10px 0; padding:10px; }
    .msg { margin:5px 0; }
    .me { text-align:right; color:blue; }
    .friend { text-align:left; color:green; }
  </style>
</head>
<body>
  <div id="app">
    <h2>Supabase Chat App</h2>

    <!-- Auth -->
    <div id="auth">
      <input id="email" type="email" placeholder="Email"/>
      <input id="password" type="password" placeholder="Password"/>
      <button onclick="signUp()">Sign Up</button>
      <button onclick="signIn()">Sign In</button>
    </div>

    <!-- After login -->
    <div id="chatApp" style="display:none;">
      <p>Logged in as: <span id="userEmail"></span></p>
      
      <h3>Add Friend</h3>
      <input id="friendEmail" type="email" placeholder="Friend's email"/>
      <button onclick="addFriend()">Add Friend</button>

      <h3>Friends List</h3>
      <ul id="friends"></ul>

      <h3>Chat</h3>
      <div id="chat"></div>
      <input id="message" type="text" placeholder="Type message"/>
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script>
    // ðŸ”‘ Supabase Config (replace with your values)
    const SUPABASE_URL = "https://qxgxfxuzswmzomljlcah.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4Z3hmeHV6c3dtem9tbGpsY2FoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0OTg4MzMsImV4cCI6MjA3MTA3NDgzM30.6mfZVMC6q4EmdRpNmQJ91fYvDkXXnxCkzRAsFvowGSU";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let currentFriend = null;

    async function signUp() {
      const { user, error } = await supabase.auth.signUp({
        email: email.value,
        password: password.value
      });
      if (error) alert(error.message);
      else alert("Signup successful! Please check your email.");
    }

    async function signIn() {
      const { data, error } = await supabase.auth.signInWithPassword({
        email: email.value,
        password: password.value
      });
      if (error) alert(error.message);
      else {
        currentUser = data.user;
        userEmail.innerText = currentUser.email;
        auth.style.display = "none";
        chatApp.style.display = "block";
        loadFriends();
      }
    }

    async function addFriend() {
      const { error } = await supabase.from("friends").insert([
        { user_id: currentUser.id, friend_email: friendEmail.value }
      ]);
      if (error) alert(error.message);
      else {
        alert("Friend added!");
        loadFriends();
      }
    }

    async function loadFriends() {
      let { data, error } = await supabase.from("friends")
        .select("*")
        .eq("user_id", currentUser.id);
      if (error) { alert(error.message); return; }

      friends.innerHTML = "";
      data.forEach(f => {
        let li = document.createElement("li");
        li.innerText = f.friend_email;
        li.onclick = () => selectFriend(f.friend_email);
        friends.appendChild(li);
      });
    }

    async function selectFriend(friend) {
      currentFriend = friend;
      chat.innerHTML = "";
      loadMessages();
      subscribeMessages();
    }

    async function loadMessages() {
      let { data, error } = await supabase.from("messages")
        .select("*")
        .or(`sender.eq.${currentUser.email},receiver.eq.${currentUser.email}`)
        .order("created_at", { ascending: true });

      if (error) { alert(error.message); return; }

      chat.innerHTML = "";
      data.filter(m => 
        (m.sender === currentUser.email && m.receiver === currentFriend) ||
        (m.sender === currentFriend && m.receiver === currentUser.email)
      ).forEach(m => {
        let div = document.createElement("div");
        div.className = "msg " + (m.sender === currentUser.email ? "me" : "friend");
        div.innerText = m.message;
        chat.appendChild(div);
      });
      chat.scrollTop = chat.scrollHeight;
    }

    async function sendMessage() {
      if (!currentFriend) { alert("Select a friend first!"); return; }
      const text = message.value;
      message.value = "";
      await supabase.from("messages").insert([
        { sender: currentUser.email, receiver: currentFriend, message: text }
      ]);
    }

    function subscribeMessages() {
      supabase.channel('realtime:messages')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
          const m = payload.new;
          if ((m.sender === currentUser.email && m.receiver === currentFriend) ||
              (m.sender === currentFriend && m.receiver === currentUser.email)) {
            let div = document.createElement("div");
            div.className = "msg " + (m.sender === currentUser.email ? "me" : "friend");
            div.innerText = m.message;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
          }
        })
        .subscribe();
    }
  </script>
</body>
  </html>
